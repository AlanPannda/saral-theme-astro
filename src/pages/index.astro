---
import BaseLayout from '../layouts/BaseLayout.astro'
import { SITE_BASE } from '../consts'
import { Icon } from 'astro-icon/components'
import BlogCard from '../components/BlogCard.astro'
import BlogTagFilter from '../components/BlogTagFilter'
import Timeline from '../components/Timeline.astro'
import { getCollection, getEntry } from 'astro:content'

const allPosts = await getCollection('blog')

const posts = allPosts
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.slice(0, 4)

// Get specific featured article
const featuredPost = await getEntry(
	'blog',
	'a-brief-treatise-on-the-color-of-tuesdays'
)

// Extract all unique tags
const allTags = ['Reviews', 'News', 'Esports', 'Guides', 'Web']

const categoryRoutes = {
	All: '/blog',
	Reviews: '/reviews',
	News: '/news',
	Esports: '/esports',
	Guides: '/guides',
	Web: '/web',
}

// Serialize posts data for React component
const postsData = allPosts.map((post) => ({
	slug: post.slug,
	title: post.data.title,
	description: post.data.description,
	pubDate: post.data.pubDate.toLocaleDateString('en-US', {
		year: 'numeric',
		month: 'short',
		day: 'numeric',
	}),
	tags: post.data.categories || [],
	coverImage: post.data.coverImageCredit?.startsWith('/')
		? `${SITE_BASE}${post.data.coverImageCredit}`
		: undefined,
}))
---

<BaseLayout>
	<main class="app-container grid lg:grid-cols-3 gap-12 pt-30 pb-10 relative">
		<!-- Left Section: Welcome + Blog Cards -->
		<div class="lg:col-span-2 space-y-12">
			{
				featuredPost && (
					<div class="w-full">
						<BlogCard post={featuredPost} />
					</div>
				)
			}
		</div>

		<!-- Right Section: Latest Posts Table -->
		<div class="space-y-6">
			<h2 class="section-title">Latest</h2>
			<Timeline
				items={posts.map((post) => ({
					title: post.data.title,
					date: post.data.pubDate.toLocaleDateString('en-US', {
						year: 'numeric',
						month: 'short',
						day: 'numeric',
					}),
					description: post.data.description,
					href: `/blog/${post.slug}`,
				}))}
			/>
		</div>
	</main>

	<!-- Featured Article Section -->
	<section class="app-container py-8">
		<h2 class="section-title">Blog</h2>
		<!-- Blog Tag Filter with Cards Grid -->
		<BlogTagFilter
			client:load
			posts={postsData}
			availableTags={allTags}
			cta={{ routes: categoryRoutes }}
		/>
	</section>

	<!-- Recent Posts Section -->
	<section class="app-container py-20 grid lg:grid-cols-2 gap-28 lg:gap-10">
		<div class="space-y-6">
			<h2 class="section-title">About Me</h2>
			<p class="text-lg max-w-xl pb-4">
				A brief introduction about yourself. You can include your profession,
				hobbies, interests, or anything you'd like visitors to know about you.
			</p>
			<a class="btn-secondary" href={`${SITE_BASE}/about`}
				>Go to About
				<Icon size={20} name="mdi:arrow-right" />
			</a>
		</div>
		<div class="space-y-6">
			<h2 class="section-title">Get in touch</h2>
			<p class="text-lg max-w-xl">
				Use the buttons below for my resume & email.
			</p>
			<div class="flex flex-wrap mt-auto space-x-4">
				<a
					class="btn-primary"
					href="mailto:example@email.com"
					download
					target="_blank"
					>Get in touch
					<Icon height={20} name="mdi:email" />
				</a>
				<a class="btn-secondary" href="https://example.com" target="_blank"
					>Download Resume
					<Icon height={20} name="mdi:arrow-collapse-down" />
				</a>
			</div>
		</div>
	</section>
</BaseLayout>
